!function(){"use strict";class e{constructor(e){this.htmlElement=e,this.resize(),this.scaleSize=25}resize(){}paint(e){console.log(JSON.stringify(e,null,2))}}class s extends e{constructor(e,s){super(e),window.sim=s,this.nextId=0}resize(){}paint(e){let s;const i=e.reduce((e,s)=>(s.aframeId||(s.aframeId=`a-sim-body-${s.name}-${this.nextId++}`),e[s.aframeId]=s,e),{}),r=document.querySelectorAll(".a-sim-body");for(s=0;s<r.length;s++)i[r[s].id]||r[s].parentNode.removeChild(r[s]);let t;e.forEach(e=>{(t=document.getElementById(e.aframeId))||(this.htmlElement.innerHTML+=`\n<a-sphere \n  id="${e.aframeId}"\n  class="a-sim-body"\n  dynamic-body \n  ${"star"===e.name?"debris-listener event-set__enter='_event: mouseenter; color: green' event-set__leave='_event: mouseleave; color: yellow'":""} \n  position="${e.x} ${e.y} ${e.z}" \n  radius="${e.drawSize/this.scaleSize}" \n  color="${e.color}">\n</a-sphere>`,t=document.getElementById(e.aframeId)),t.object3D.position.set(e.x,e.y,e.z)})}}AFRAME.registerComponent("debris-listener",{init:function(){function e(e){return(Math.random()-.5)*e}this.el.addEventListener("click",(function(s){for(let s=0;s<10;s++)window.sim.addBodyArgs("debris","white",e(10),e(10),e(10),1,e(.1),e(.1),e(.1))}))}});class i{constructor(e,s,i,r,t,o,a,n,d){this.name=e,this.color=s,this.x=i,this.y=r,this.z=t,this.mass=o,this.vX=a||0,this.vY=n||0,this.vZ=d||0,this.forceX=0,this.forceY=0,this.forceZ=0,this.drawSize=Math.min(Math.max(Math.log10(o),1),10)}}class r{constructor(){this.setupWebWorker(),this.simulationSpeed=33,this.objBodies=[],this.bodySize=4,this.forceSize=3,this.debrisBounds=12,this.workerReady=!1,this.workerCalculating=!1,this.visualizations=[]}ready(){return this.workerReady&&!this.workerCalculating}addBody(e){this.objBodies.push(e)}addBodyArgs(e,s,r,t,o,a,n,d,c){this.addBody(new i(e,s,r,t,o,a,n,d,c))}start(){const e=this.step.bind(this);setInterval(e,this.simulationSpeed)}async step(){this.ready()?await this.calculateForces():console.log(`Skipping sim calcuation.  Worker is busy:${this.workerCalculating}`),this.trimDebris(),this.applyForces(),this.visualize()}calculateForces(){this.workerCalculating=!0,this.arrBodies=[],this.objBodies.forEach((e,s)=>{const i=s*this.bodySize;this.arrBodies[i]=e.x,this.arrBodies[i+1]=e.y,this.arrBodies[i+2]=e.z,this.arrBodies[i+3]=e.mass});const e=new Promise((e,s)=>{this.forcesResolve=e,this.forcesReject=s});return this.worker.postMessage({purpose:"nBodyForces",arrBodies:this.arrBodies}),e}trimDebris(){this.objBodies=this.objBodies.filter(e=>"debris"!==e.name||!(isNaN(e.x)||isNaN(e.y)||isNaN(e.z))&&(!(e.x<-this.debrisBounds||e.x>this.debrisBounds)&&(!(e.y<-this.debrisBounds||e.y>this.debrisBounds)&&!(e.z<-this.debrisBounds||e.z>this.debrisBounds))))}applyForces(){this.objBodies.forEach((e,s)=>{0!==e.mass&&this.arrForces&&(e.forceX=this.arrForces[s*this.forceSize+0],e.forceY=this.arrForces[s*this.forceSize+1],e.forceZ=this.arrForces[s*this.forceSize+2],e.vX=e.vX+e.forceX/e.mass,e.vY=e.vY+e.forceY/e.mass,e.vZ=e.vZ+e.forceZ/e.mass,e.x=e.x+e.vX,e.y=e.y+e.vY,e.z=e.z+e.vZ)})}visualize(){this.visualizations.forEach(e=>{e.paint(this.objBodies)})}addVisualization(e){this.visualizations.push(e)}setupWebWorker(){this.worker=new Worker("workerWasm.js"),this.worker.onerror=function(e){console.log(`Error from Web Worker: ${e.message}`)};const e=this;this.worker.onmessage=function(s){if(s&&s.data){const i=s.data;switch(i.purpose){case"wasmReady":e.workerReady=!0;break;case"nBodyForces":e.workerCalculating=!1,i.error?e.forcesReject(i.error):(e.arrForces=i.arrForces,e.forcesResolve(e.arrForces))}}},WebAssembly.compileStreaming(fetch("assembly/nBodyForces.wasm")).then(s=>{e.worker.postMessage({purpose:"wasmModule",wasmModule:s})})}}window.onload=function(){const e=new r;e.addVisualization(new s(document.getElementById("a-bodies"),e)),e.addBody(new i("star","yellow",0,0,1,1e9)),e.addBody(new i("hot-jupiter","red",-1,-1,1,1e4,.24,-.05,0)),e.addBody(new i("cold-jupiter","purple",4,4,.5,1e4,-.07,.04,0)),e.start(),e.addBody(new i("saturn","blue",-8,-8,.1,1e3,.07,-.035,0))}}();
//# sourceMappingURL=main.js.map
